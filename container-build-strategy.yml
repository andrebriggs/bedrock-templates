parameters:
- name: buildArgs
  type: object
  default: []
- name: downloadTools
  type: boolean
  default: true
- name: imageName # name of the parameter; required
  type: string # data type of the parameter; required
- name: imageTag
  type: string
- name: imageRepoType
  type: string
  default: ACR
- name: enableIntrospetion
  type: boolean
  default: true

# variables:
#   - group: agent-build-vg
  # - template: app-variables.yml  # Template reference
  
steps:
- ${{ if eq(parameters.downloadTools, true) }}:
  - task: HelmInstaller@1
    inputs:
      helmVersionToInstall: 2.16.3
# - bash: |-
#     echo "##vso[task.setvariable variable=buildargsdelimited]"${{join(';',parameters.buildArgs.*)}}""
#     echo buildargsdelimited: $buildargsdelimited
#   failOnStderr: true
#   displayName: Set Variables
- script: |-
    echo imageName: ${{ parameters.imageName }}
    echo imageTag: ${{ parameters.imageTag }}
    echo BuildArgs: "${{join(';',parameters.buildArgs.*)}}"
    echo $(System.DefaultWorkingDirectory)
    cd $(System.DefaultWorkingDirectory)
    ls -la
    sudo chmod +x *RegistryBuild.sh
  failOnStderr: true
  displayName: Debugging messages
- task: Bash@3
  inputs:
    # targetType: 'filePath'
    ${{ if eq(parameters.imageRepoType, 'ACR') }}:
      filePath: AzureContainerRegistryBuild.sh
    ${{ if eq(parameters.imageRepoType, 'DockerHub') }}:
      filePath: DockerHubRegistryBuild.sh
    failOnStderr: true
  env:
    IMAGE_TAG: ${{ parameters.imageTag }}
    BUILD_REPO_NAME: ${{ parameters.imageName }}
    BUILD_ARG_DELIMITED: ${{join(';',parameters.buildArgs.*)}}
    # BUILD_ARG_DELIMITED: "${{join(';',parameters.buildArgs.*)}}" 
    ${{ each item in parameters.buildArgs.* }}: # We want the bash script to have access to the var values
      ${{ item }}: ${{ format('${0}', item) }}
  displayName: Execute Docker Image Build
# - ${{ if ne(parameters.BuildArgVariableGroup, '') }}:
#   - script: |-
#       echo BuildArgVariableGroup: ${{ parameters.BuildArgVariableGroup }}
# - ${{ each item in parameters.buildArgs.* }}:
#   - script: echo ${{ item }}
